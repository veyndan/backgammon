@layer reset {
	*, ::before, ::after {
		box-sizing: border-box;
	}

	body {
		margin: 0;
	}
}

@layer typography {
	.typography-body-large-700 {
		font: 700 4.375cqmin/1 system-ui;
	}

	.typography-body-medium-700 {
		font: 700 3.9375cqmin/1 system-ui;
	}

	.typography-body-small-700 {
		font: 700 2.625cqmin/1 system-ui;
	}

	.typography-label-large-700 {
		font: 700 3.0625cqmin/1.43 system-ui;
	}

	.typography-label-small-700 {
		font: 700 1.75cqmin/1 system-ui;
	}

	.typography-label-small-400 {
		font: 400 1.75cqmin/1 system-ui;
	}
}

@layer palette {
	:root {
		--primary: light-dark(#a0d49b, #39693b);
		--on-primary: light-dark(#ffffff, #083910);
		--secondary: light-dark(#52634f, #b9ccb4);
		--on-secondary: light-dark(#ffffff, #253423);
		--tertiary: light-dark(#39656b, #a1ced4);
		--on-tertiary: light-dark(#ffffff, #00363b);
		--primary-container: light-dark(hsl(115.9 65.9% 82.7%), hsl(121.3 39.1% 22.5%));
		--on-primary-container: light-dark(#002105, #bbf0b5);
		--secondary-container: light-dark(#d5e8cf, #3b4b39);
		--on-secondary-container: light-dark(#101f10, #d5e8cf);
		--tertiary-container: light-dark(#bcebf1, #1f4d52);
		--on-tertiary-container: light-dark(#001f23, #bcebf1);
		--surface-dim: light-dark(#d7dbd3, #10140f);
		--surface: light-dark(hsl(84 55.6% 96.5%), hsl(108 14.3% 6.9%));
		--surface-bright: light-dark(#f7fbf1, #363a34);
		--surface-container-lowest: light-dark(#ffffff, #0b0f0a);
		--surface-container-low: light-dark(#f1f5ec, #181d17);
		--surface-container: light-dark(#ebefe6, #1c211b);
		--surface-container-high: light-dark(#e6e9e0, #272b25);
		--surface-container-highest: light-dark(#e0e4db, #323630);
		--on-surface: light-dark(#181d17, #e0e4db);
		--on-surface-variable: light-dark(#424940, #c2c9bd);
		--outline: light-dark(#72796f, #8c9388);
		--outline-variant: light-dark(#c2c9bd, #424940);
		--inverse-surface: light-dark(#2d322c, #e0e4db);
		--inverse-on-surface: light-dark(#eef2e9, #2d322c);
		--inverse-primary: light-dark(#9fd49c, #3b693a);
		--scrim: light-dark(#000000, #000000);
		--shadow: light-dark(#000000, #000000);
	}

	.surface {
		color: var(--on-surface);
		background: var(--surface);
	}
}

:root {
	--bar-width-unitless: 38;
	--checker-diameter-unitless: calc(var(--checker-radius-unitless) * 2);
	--checker-radius-unitless: 16;
	--checker-thickness-unitless: 5;
	--checkers-per-player: 15;
	--die-side-length-unitless: 36;
	--half-height-unitless: calc(var(--point-height-unitless) * 2 + var(--checker-diameter-unitless) * 2 + var(--die-side-length-unitless) + 61);
	--half-width-unitless: calc(var(--point-width-unitless) * 6);
	--hold-width-unitless: calc(var(--checker-diameter-unitless));
	--point-count: 24;
	--point-height-unitless: calc(var(--checker-diameter-unitless) * 4);
	--point-max: 24;
	--point-min: 1;
	--point-per-side: calc(var(--point-count) / 2);
	--point-width-unitless: var(--checker-diameter-unitless);

	color-scheme: light dark;
}

@keyframes fade-in {
	from {
		opacity: 0;
	}
	to {
		opacity: 1;
	}
}

@keyframes flex-grow {
	from {
		flex: 0;
		margin-inline: 0;
	}
	to {
		flex: 0 1 calc(var(--die-side-length-unitless) * .21875cqmin + 3.0625cqmin);
	}
}

button {
	cursor: pointer;

	&:disabled {
		cursor: not-allowed;
	}
}

[data-player="1"] {
	--player-current-checker-background: var(--surface-container-lowest);
	--player-current-checker-text-color: var(--on-surface);
}

[data-player="2"] {
	--player-current-checker-background: var(--on-surface);
	--player-current-checker-text-color: var(--surface-container-lowest);
}

html {
	block-size: 100dvb;
	font: 16px/1.5 system-ui;

	& > body {
		display: flex;
		flex-direction: column;
		gap: 8px;

		block-size: 100%;
		padding: 16px;

		& > :not(main) > * {
			margin-inline: auto;
			padding-inline: 1rem;
		}

		& > header > nav {
			& > ul {
				display: flex;
				flex-wrap: wrap;
				gap: 1em;

				padding-inline: 0;

				font-weight: bold;
				list-style-type: none;

				& > li:first-child:has(> a[href="/index.html"]) {
					margin-inline-end: auto;
				}
			}

			a {
				&:any-link {
					color: LinkText;
				}

				&[aria-current="page"] {
					color: inherit;
					text-decoration: inherit;
				}
			}
		}

		& > main {
			min-block-size: 0;
			margin-block: auto;

			&:has(> .backgammon > .aspect-ratio-lock > #play-mode > option[value="opposite"]:checked) {
				&[data-player="1"] > .backgammon > .aspect-ratio-lock > #board > #controls > div {
					&:first-of-type {
						grid-area: controls-left;
					}

					&:last-of-type {
						grid-area: controls-right;
					}
				}

				&[data-player="2"] > .backgammon > .aspect-ratio-lock > #board > #controls > div {
					rotate: .5turn;

					&:first-of-type {
						grid-area: controls-right;
					}

					&:last-of-type {
						grid-area: controls-left;
					}
				}

				& > .backgammon {
					aspect-ratio: 32 / 21;

					& > .aspect-ratio-lock {
						grid-template:
							".       .     drop-points-top    drop-points-top    drop-points-top    .       .        " 2.625cqb
							"players timer quadrant-13-18     bar                quadrant-19-24     sidebar play-mode" auto
							"players timer controls-left      bar                controls-right     sidebar play-mode" auto
							"players timer quadrant-7-12      bar                quadrant-1-6       sidebar play-mode" auto
							".       .     drop-points-bottom drop-points-bottom drop-points-bottom .       .        " 2.625cqb /
							auto     auto  auto               auto               auto               auto    auto      ;

						& > #players {
							writing-mode: sideways-lr;
						}

						& > #timer {
							writing-mode: sideways-lr;
						}

						& > #play-mode {
							writing-mode: sideways-rl;

							& > button > svg {
								rotate: .25turn;
							}
						}
					}
				}
			}

			&:has(> .backgammon > .aspect-ratio-lock > #play-mode > option[value="side-by-side"]:checked) {
				&[data-player="1"] > .backgammon > .aspect-ratio-lock > #board > #controls > div {
					&:first-of-type {
						grid-area: controls-right;
					}

					&:last-of-type {
						grid-area: controls-left;
					}
				}

				&[data-player="2"] > .backgammon > .aspect-ratio-lock > #board > #controls > div {
					&:first-of-type {
						grid-area: controls-left;
					}

					&:last-of-type {
						grid-area: controls-right;
					}
				}

				& > .backgammon {
					aspect-ratio: 20 / 21;

					& > .aspect-ratio-lock {
						grid-template:
							".         players            players            players            .       " auto
							".         timer              timer              timer              .       " auto
							".         drop-points-top    drop-points-top    drop-points-top    .       " 2.625cqb
							"play-mode quadrant-13-18     bar                quadrant-19-24     sidebar " auto
							"play-mode controls-left      bar                controls-right     sidebar " auto
							"play-mode quadrant-7-12      bar                quadrant-1-6       sidebar " auto
							".         drop-points-bottom drop-points-bottom drop-points-bottom .       " 2.625cqb /
							auto       auto               auto               auto               auto    ;

						& > #players {
							justify-self: center;
						}

						& > #timer {
							justify-self: center;
						}

						& > #play-mode {
							writing-mode: sideways-lr;

							& > button > svg {
								rotate: .75turn;
							}
						}
					}
				}
			}

			&[data-player="1"] > .backgammon > .aspect-ratio-lock > #players > veyndan-player[data-player="1"],
			&[data-player="2"] > .backgammon > .aspect-ratio-lock > #players > veyndan-player[data-player="2"] {
				background: var(--primary-container);
			}

			& > .backgammon {
				container-type: size;
				max-block-size: 100%;
				margin-inline: auto;

				& > .aspect-ratio-lock {
					display: grid;
					gap: 1.75cqmin;
					align-items: stretch;
					justify-content: center;

					block-size: 100%;

					& > #players {
						display: flex;
						grid-area: players;
						gap: 1.75cqmin;
						align-self: center;
					}

					& > #timer {
						display: flex;
						grid-area: timer;
						gap: 1.75cqmin;
						align-items: center;
						align-self: center;

						padding-block: .875cqmin;
						padding-inline: 3.0625cqmin;
						border-radius: 1.75cqmin;

						background: var(--surface-container-high);

						& > #move {
							color: var(--secondary);
						}
					}

					/* TODO Add additional 8px spacing between board and timer & board and play mode. */
					& > #board {
						display: contents;

						/*noinspection CssInvalidFunction*/
						.drop-point,
						#checkers > *:not([data-hit]) {
							/* Returns 1 if the --point is in [1,12], else 0. */
							--is-bottom-point: calc(1 - var(--is-top-point));
							/* Returns 1 if the --point is in [13,24], else 0. */
							--is-top-point: round(down, calc((var(--point) - 1) / var(--point-per-side)), 1);
							/* Returns 1 if the --point is in [1,6] âˆª [19,24], else 0. */
							--is-right-point: round(down, abs(calc((var(--point-max) + var(--point-min)) / 2) - var(--point)) / 6, 1);
							--translate-x:
								calc(
									var(--is-top-point) * (var(--checker-diameter-unitless) * .21875cqmin * rem(var(--point) - 1, var(--point-per-side)))
									+ var(--is-bottom-point) * (2 * var(--half-width-unitless) * .21875cqmin - var(--checker-diameter-unitless) * .21875cqmin * (rem(var(--point) - 1, var(--point-per-side)) + 1))
									+ var(--is-right-point) * (var(--bar-width-unitless) * .21875cqmin + 3.5cqmin)
								);
						}

						& > .half {
							display: flex;
							flex-direction: column;
							justify-content: space-between;

							aspect-ratio: var(--half-width-unitless) / var(--half-height-unitless);
							min-block-size: 0;

							background: var(--primary-container);
							clip-path: fill-box inset(0 round 1.75cqmin);

							&#outer-board {
								grid-area: quadrant-13-18 / quadrant-13-18 / quadrant-7-12 / quadrant-7-12;
							}

							&#inner-board {
								grid-area: quadrant-19-24 / quadrant-19-24 / quadrant-1-6 / quadrant-1-6;
							}

							& > .quadrant {
								display: flex;

								& > veyndan-point {
									&:nth-child(even) {
										color: hsl(from var(--secondary) h s 50%);
									}

									&:nth-child(odd) {
										color: var(--primary);
									}
								}

								&:last-of-type {
									transform: scale(-1, -1);
								}
							}
						}

						& > .bar {
							grid-area: bar;
							aspect-ratio: var(--bar-width-unitless) / var(--half-height-unitless);
							border-radius: 1.75cqmin;
							background: var(--secondary-container);
						}

						& > #sidebar {
							display: flex;
							grid-area: sidebar;
							align-items: center;
							justify-content: space-evenly;

							writing-mode: sideways-rl;

							& > .hold {
								--checker-radius-unitless: 14;
								--gap-unitless: 1;
								--padding-unitless: 2;

								display: flex;
								flex-direction: row-reverse;
								gap: calc(var(--gap-unitless) * .21875cqmin);

								aspect-ratio: var(--hold-width-unitless) / calc(var(--checkers-per-player) * var(--checker-thickness-unitless) + 2 * var(--padding-unitless) + (var(--checkers-per-player) - 1) * var(--gap-unitless));
								block-size: calc(var(--hold-width-unitless) * .21875cqmin);
								padding: calc(var(--padding-unitless) * .21875cqmin);
								border-radius: .875cqmin;

								background: var(--secondary-container);
							}

							& > #doubling-cube-face {
								--die-side-length-unitless: 28;

								display: flex;
								align-items: center;
								justify-content: center;

								aspect-ratio: 1;
								inline-size: calc(var(--die-side-length-unitless) * .21875cqmin);
								border-radius: .875cqmin;

								color: var(--on-secondary-container);

								background: var(--secondary-container);
							}
						}

						& > #controls {
							display: contents;

							& > div {
								z-index: 1;

								display: flex;
								gap: 1.75cqmin;
								align-items: center;
								justify-content: center;

								& > button {
									--surface: var(--player-current-checker-background);
									--color: var(--player-current-checker-text-color);
									--alpha: 1;

									padding-block: calc(36.75cqmin / 16);
									padding-inline: calc(73.5cqmin / 16);
									border: none;
									border-radius: 1.75cqmin;

									color: hsl(from var(--color) h s l / var(--alpha));

									background: hsl(from var(--surface) h s l / var(--alpha));

									&:disabled {
										--alpha: .5;
									}

									&:hover:not(:disabled) {
										--alpha: .85;
									}

									&#confirm {
										--surface: hsl(149 83% 28%);
										--color: hsl(0 0% 100%);
									}
								}

								& > #dice-container {
									display: none;
									flex-direction: column;
									align-items: center;

									inline-size: 100%;
									margin-block-end: 3.5cqmin;

									&:has(> #dice > veyndan-die:not(.rolling):first-child:nth-last-child(2)) {
										cursor: pointer;

										& > #dice-swap {
											visibility: visible;
										}
									}

									& > #dice-swap {
										block-size: 2.625cqmin;
										margin-block: -.21875cqmin;
										visibility: hidden;
									}

									& > #dice {
										display: flex;
										justify-content: center;

										margin: 0;
										padding: 0;

										list-style-type: none;

										& > veyndan-die {
											overflow: hidden;
											flex: 0 1 calc(var(--die-side-length-unitless) * .21875cqmin + 3.0625cqmin);
											margin-inline: .4375cqmin;

											&:nth-child(n + 3) {
												animation: .5s .2s backwards flex-grow,
												.2s .8125s backwards fade-in;
											}
										}
									}
								}
							}
						}

						& > #checkers {
							pointer-events: none;
							z-index: 2;
							grid-area: quadrant-13-18 / quadrant-13-18 / quadrant-1-6 / quadrant-1-6;

							/*noinspection CssInvalidFunction*/
							& > veyndan-checker {
								pointer-events: auto;

								position: absolute;

								display: flex;
								align-items: center;
								justify-content: center;

								transition: translate .3s;

								&:not([data-permissible-destination-points="[]"]) {
									&:hover {
										cursor: pointer;
									}

									&.dragging {
										cursor: move;
										filter: drop-shadow(2px 4px 4px hsl(from var(--surface) h s l / .3));
										transition: filter .3s;
									}
								}

								&[data-permissible-destination-points="[]"]:hover {
									cursor: not-allowed;
								}

								& > text {
									user-select: none;
									dominant-baseline: central;
									text-anchor: middle;
									fill: currentColor;

									/* Hide node from accessibility tree when empty. */
									&:empty {
										display: none;
									}
								}

								&[data-hit] {
									translate: calc(var(--half-width-unitless) * .21875cqmin + 1.75cqmin + (var(--bar-width-unitless) * .21875cqmin - var(--checker-diameter-unitless) * .21875cqmin) / 2) var(--translate-y);

									&[data-player="1"] {
										--translate-y: calc(var(--checker-diameter-unitless) * .21875cqmin * 2.5);
									}

									&[data-player="2"] {
										--translate-y: calc(var(--half-height-unitless) * .21875cqmin - var(--checker-diameter-unitless) * .21875cqmin * 3.5);
									}
								}

								&:not([data-hit]) {
									--top-point-translate-y: calc(var(--checker-diameter-unitless) * .21875cqmin * min(var(--point-stack-index), ((5 - 1) * var(--point-stack-index)) / max(var(--point-stack-count) - 1, 1)));
									--bottom-point-translate-y: calc(var(--half-height-unitless) * .21875cqmin - var(--top-point-translate-y) - var(--checker-diameter-unitless) * .21875cqmin);

									--top-point-mask-position-vertical: calc(150% + -1 * round(down, calc(var(--point-stack-count) / 6), 1) * (1 - round(down, calc((var(--point-stack-index) + 1) / var(--point-stack-count)), 1)) * (105% - ((4 / max(var(--point-stack-count) - 1, 1)) * 100%)));
									--bottom-point-mask-position-vertical: calc(100% - var(--top-point-mask-position-vertical));

									translate:
										var(--translate-x)
										calc(
											var(--is-top-point) * var(--top-point-translate-y)
											+ var(--is-bottom-point) * var(--bottom-point-translate-y)
										);
									mask-image:
										radial-gradient(
											black calc(var(--checker-radius-unitless) * .21875cqmin),
											transparent calc(var(--checker-radius-unitless) * .21875cqmin)
										),
										radial-gradient(
											circle at center calc(var(--is-top-point) * var(--top-point-mask-position-vertical) + var(--is-bottom-point) * var(--bottom-point-mask-position-vertical)),
											black calc(var(--checker-radius-unitless) * .21875cqmin),
											transparent calc(var(--checker-radius-unitless) * .21875cqmin)
										);
									mask-composite: subtract;
								}
							}
						}

						& > #drop-points {
							pointer-events: none;
							grid-area: drop-points-top / drop-points-top / drop-points-bottom / drop-points-bottom;

							/*noinspection CssInvalidFunction*/
							& > .drop-point {
								--drop-point-diameter: 2.625cqmin;

								position: absolute;
								translate:
									calc(
										var(--translate-x) + (var(--checker-diameter-unitless) * .21875cqmin - var(--drop-point-diameter)) / 2
									)
									calc(
										var(--is-bottom-point) * (var(--half-height-unitless) * .21875cqmin + 6.125cqmin)
									);

								aspect-ratio: 1;
								block-size: var(--drop-point-diameter);
								border-radius: 50%;

								background: darkorange;
							}
						}
					}

					& > #play-mode {
						grid-area: play-mode;
						gap: 1.3125cqmin;
						align-items: center;
						align-self: center;
						justify-items: start;

						block-size: 7cqmin;
						padding-inline: 3.5cqmin 2.8cqmin;
						border: none;
						border-radius: 3.5cqmin;

						color: var(--on-surface);

						appearance: base-select;
						background: var(--on-tertiary);

						&::picker-icon {
							/*content: "a"; TODO Convert this to the svg using a background: url(data-base64-of-svg) so we can animate rotation. */
							content: "";
							transition: 0.4s rotate;
						}

						&::picker(select) {
							inset-block-start: calc(anchor(outside) + .875cqmin);
							inset-inline-start: anchor(self-start);

							border: .525cqmin white solid;
							border-radius: 1.75cqmin;

							color: var(--on-surface);

							appearance: base-select;
							background: var(--tertiary-container);
						}

						&:open::picker-icon {
							rotate: 180deg;
						}

						& > button > svg {
							aspect-ratio: 1;
							inline-size: 2.625cqmin;
							fill: currentColor;
						}

						& > option {
							gap: 3.5cqmin;
							padding-block: 3.5cqmin;
							padding-inline: 7cqmin;

							&::checkmark {
								order: 1;
							}
						}
					}
				}
			}
		}
	}
}
